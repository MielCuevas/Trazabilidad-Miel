<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidad Miel - dApp para Polygon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ✅ LIBRERÍA ETHERS.JS CORREGIDA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" type="application/javascript"></script>
    <!-- Librerías para PDF, Imagen y QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4dGzcHQeWILTYP_w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .honey-gradient { background: linear-gradient(135deg, #fcd34d, #fbbf24); }
        .btn-primary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; width: 20px; height: 20px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tab-btn.active { border-color: #f59e0b; color: #f59e0b; background-color: #fff; }
        .tab-btn { border-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
        .label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #4b5563; }
        .input-field { display: block; width: 100%; padding: 0.75rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.5rem; }
        .input-field:focus { outline: none; box-shadow: 0 0 0 2px #fcd34d; border-color: #f59e0b; }
        .input-field:disabled { background-color: #e5e7eb; }
        .hidden-file { display: none; }
        .label-file { cursor: pointer; background-color: #fef3c7; color: #92400e; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; text-align: center; display: block; transition: background-color 0.2s; }
        .label-file:hover { background-color: #fde68a; }
        .image-preview-small { max-height: 40px; border-radius: 0.25rem; margin-top: 0.5rem; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 max-w-4xl">
        <header class="text-center mb-10">
            <div class="inline-flex items-center gap-4 mb-3">
                <div class="honey-gradient p-3 rounded-full shadow-lg">
                    <svg class="w-10 h-10 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M21.7,8.35c-0.42-1.49-1.5-2.7-2.82-3.25C17.27,4.46,15.7,4,14,4h-4C8.3,4,6.73,4.46,5.12,5.1C3.8,5.65,2.72,6.86,2.3,8.35C1.82,10.01,2.15,11.78,3.2,13.09l5.8,7.39c0.39,0.5,0.94,0.78,1.54,0.85h0.01c0.61-0.07,1.15-0.35,1.54-0.85l5.8-7.39C21.85,11.78,22.18,10.01,21.7,8.35z M12,14c-1.1,0-2-0.9-2-2s0.9-2,2-2s2,0.9,2,2S13.1,14,12,14z"/></svg>
                </div>
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 tracking-tight">dApp de Trazabilidad</h1>
            </div>
            <p class="text-gray-500 text-lg">Miel de Cuevas de San Clemente en la Blockchain de Polygon</p>
        </header>

        <div id="wallet-connection" class="card p-8 text-center">
            <h2 class="text-2xl font-bold mb-4">Conecta tu Cartera</h2>
            <p class="mb-6 text-gray-600 max-w-md mx-auto">Para empezar, conecta tu cartera de MetaMask.</p>
            <div class="flex justify-center">
                <button id="connect-metamask-btn" class="btn-primary font-bold py-3 px-8 rounded-lg inline-flex items-center justify-center gap-2 w-full sm:w-auto">Conectar MetaMask</button>
            </div>
        </div>
        
        <div id="wallet-info" class="mb-6 text-sm font-mono hidden bg-gray-100 p-3 rounded-lg flex items-center justify-between">
            <span id="wallet-address-display"></span>
            <button id="disconnect-btn" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-lg">Desconectar</button>
        </div>


        <main id="dapp-content" class="hidden space-y-8">
            <section id="admin-panel" class="card p-6 hidden bg-red-50 border-2 border-red-200">
                <h2 class="text-xl font-bold text-red-800 mb-4 text-center">Panel de Administrador</h2>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <div class="text-center">
                        <span class="label">Estado del Contrato:</span>
                        <span id="contract-status" class="font-bold text-lg">Consultando...</span>
                    </div>
                    <button id="pause-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-3"><span class="btn-text">Pausar Contrato</span><div class="spinner hidden"></div></button>
                    <button id="unpause-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-3"><span class="btn-text">Reanudar Contrato</span><div class="spinner hidden"></div></button>
                </div>
            </section>

            <div class="card p-8">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-lote" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Registrar Lote</button>
                        <button id="tab-venta" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Poner Lote en Venta</button>
                    </nav>
                </div>
                
                <div id="content-lote" class="tab-content active">
                    <form id="lote-form" class="space-y-8">
                        <fieldset><legend class="text-xl font-semibold text-gray-900 mb-4">Datos del Apicultor</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="apicultor-nombre" class="label">Nombre</label><input type="text" id="apicultor-nombre" value="Gonzalo Alonso García" class="input-field"></div>
                                <div><label for="apicultor-rega" class="label">Nº REGA</label><input type="text" id="apicultor-rega" value="ES091190000329" class="input-field"></div>
                            </div>
                        </fieldset>
                        <fieldset><legend class="text-xl font-semibold text-gray-900 mb-4">Datos del Lote</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="lote-kilos" class="label">Kilos Totales del Lote</label><input type="number" id="lote-kilos" value="100" class="input-field"></div>
                                <div><label for="lote-ubicacion" class="label">Ubicación (Ej: Coordenadas)</label><input type="text" id="lote-ubicacion" value="42.1400, -3.5800" class="input-field"></div>
                                
                                <div class="text-center"><label for="lote-fecha-cosecha" class="label mb-2">Fecha Cosecha</label><input type="date" id="lote-fecha-cosecha" class="input-field mb-2"><label for="lote-img-cosecha" class="label-file">Subir Foto</label><input type="file" id="lote-img-cosecha" class="hidden-file" accept="image/*"><img id="preview-cosecha" class="image-preview-small mx-auto hidden"></div>
                                <div class="text-center"><label for="lote-fecha-extraccion" class="label mb-2">Fecha Extracción</label><input type="date" id="lote-fecha-extraccion" class="input-field mb-2"><label for="lote-img-extraccion" class="label-file">Subir Foto</label><input type="file" id="lote-img-extraccion" class="hidden-file" accept="image/*"><img id="preview-extraccion" class="image-preview-small mx-auto hidden"></div>
                                <div class="text-center"><label for="lote-fecha-maduracion" class="label mb-2">Fecha Maduración</label><input type="date" id="lote-fecha-maduracion" class="input-field mb-2"><label for="lote-img-maduracion" class="label-file">Subir Foto</label><input type="file" id="lote-img-maduracion" class="hidden-file" accept="image/*"><img id="preview-maduracion" class="image-preview-small mx-auto hidden"></div>
                                <div class="text-center"><label for="lote-fecha-envasado" class="label mb-2">Fecha Envasado</label><input type="date" id="lote-fecha-envasado" class="input-field mb-2"><label for="lote-img-envasado" class="label-file">Subir Foto</label><input type="file" id="lote-img-envasado" class="hidden-file" accept="image/*"><img id="preview-envasado" class="image-preview-small mx-auto hidden"></div>
                            </div>
                        </fieldset>
                         <fieldset><legend class="text-xl font-semibold text-gray-900 mb-4">Características de la Miel</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label for="miel-variedad" class="label">Variedad</label><select id="miel-variedad" class="input-field"><option>Brecina</option><option>Brezo</option><option selected>Multi Floral</option><option>Otros</option></select></div>
                                <div><label for="miel-extraccion-tipo" class="label">Tipo de Extracción</label><input type="text" id="miel-extraccion-tipo" value="Extractor radial eléctrico de 3 cuadros - Madurador con doble tamiz" class="input-field"></div>
                                <div class="md:col-span-2"><label for="miel-detalles" class="label">Detalles Adicionales (Opcional)</label><textarea id="miel-detalles" rows="2" class="input-field" placeholder="Ej: Cosecha de primavera, notas afrutadas..."></textarea></div>
                            </div>
                        </fieldset>
                    </form>
                    <div class="text-center mt-8"><button id="preview-lote-btn" class="btn-primary font-bold py-3 px-8 rounded-lg w-full sm:w-auto flex items-center justify-center gap-3"><span class="btn-text">Previsualizar Lote</span></button></div>
                </div>
                
                <div id="content-venta" class="tab-content">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Poner un Lote en Venta Pública</h2>
                    <div class="space-y-6 max-w-lg mx-auto">
                        <div><label for="venta-lote-select" class="label">Selecciona uno de tus lotes</label><select id="venta-lote-select" class="input-field"><option>Cargando tus lotes...</option></select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="venta-precio-eur" class="label">Precio por Kilo (€)</label><input type="number" id="venta-precio-eur" placeholder="12.50" class="input-field"></div>
                            <div><label for="venta-precio-matic" class="label">Precio por Kilo (MATIC)</label><input type="text" id="venta-precio-matic" class="input-field" disabled></div>
                        </div>
                        <div class="text-xs text-gray-500 text-center" id="matic-rate-info">Cargando tipo de cambio...</div>
                        <div><label for="venta-img-producto" class="label">Imagen del Producto Final</label><input type="file" id="venta-img-producto" class="hidden-file" accept="image/*"><label for="venta-img-producto" class="label-file">Subir Foto del Producto</label><img id="preview-venta-producto" class="image-preview-small mx-auto hidden"></div>
                    </div>
                     <div class="text-center mt-8 max-w-lg mx-auto"><button id="preview-venta-btn" class="btn-primary font-bold py-3 px-8 rounded-lg w-full flex items-center justify-center gap-3"><span class="btn-text">Previsualizar y Poner en Venta</span></button></div>
                </div>

            </div>
            <div id="notification" class="mt-6"></div>
        </main>
        <section id="verifier-section" class="card p-8 mt-8 hidden">
            <h2 class="text-2xl font-semibold mb-6 text-center">Verificador de Datos del Contrato</h2>
            <div class="space-y-4">
                <button id="find-my-lots-btn" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-black transition w-full">Buscar Mis Lotes Creados</button>
                <div>
                    <label for="my-lots-dropdown" class="label">Selecciona un Lote para ver sus detalles</label>
                    <select id="my-lots-dropdown" class="input-field hidden"></select>
                </div>
            </div>
            <div id="verifier-result" class="mt-6"></div>
        </section>
        
        <footer class="text-center mt-8 text-xs text-gray-400"><p>Interactuando con un Contrato Inteligente en la Blockchain de Polygon.</p></footer>
    </div>
    
    <!-- Modal de Previsualización de Lote -->
    <div id="preview-lote-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-4xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-3xl font-bold text-center mb-4">Previsualización del Informe de Lote</h2>
            <div class="overflow-y-auto p-2 bg-gray-50 border rounded-lg">
                <div id="preview-lote-content" class="p-6 bg-white"></div>
            </div>
            <div class="mt-6 flex flex-wrap justify-center gap-4">
                <button id="download-lote-png-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Descargar PNG</button>
                <button id="download-lote-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Descargar PDF</button>
                <button id="confirm-register-lote-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg flex items-center justify-center gap-3"><span class="btn-text">Confirmar y Registrar</span><div class="spinner hidden"></div></button>
                <button id="cancel-lote-preview-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Previsualización de Venta -->
    <div id="preview-venta-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-3xl font-bold text-center mb-4">Previsualización de Puesta en Venta</h2>
            <div class="overflow-y-auto p-2 bg-gray-50 border rounded-lg">
                <div id="preview-venta-content" class="p-6 bg-white"></div>
            </div>
            <div class="mt-6 flex flex-wrap justify-center gap-4">
                <button id="download-venta-png-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Descargar PNG</button>
                <button id="download-venta-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Descargar PDF</button>
                <button id="confirm-register-venta-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-lg flex items-center justify-center gap-3"><span class="btn-text">Confirmar y Poner en Venta</span><div class="spinner hidden"></div></button>
                <button id="cancel-venta-preview-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Recibo de Transacción -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-3xl font-bold text-center mb-4 text-green-600">¡Operación Confirmada!</h2>
            <div class="overflow-y-auto p-2 bg-gray-50 border rounded-lg">
                <div id="receipt-content" class="p-6 bg-white"></div>
            </div>
            <div class="mt-6 flex flex-wrap justify-center gap-4">
                <button id="download-receipt-png-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg">Descargar Recibo PNG</button>
                <button id="download-receipt-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-lg">Descargar Recibo PDF</button>
                <button id="close-receipt-btn" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            
            // ✅ DIRECCIÓN DE TU CONTRATO DE PRODUCCIÓN EN POLYGON
            const CONTRACT_ADDRESS = "0x9099b9E6AbB01E4b0327D6CF19b3896557588C4d"; 
            const POLYGON_CHAIN_ID = '0x89'; // 137 para Polygon Mainnet.
            
            // ✅ ABI COMPLETO Y CORRECTO PARA EL CONTRATO DE PRODUCCIÓN
            const CONTRACT_ABI = [{"inputs":[{"internalType":"uint256","name":"_loteId","type":"uint256"},{"internalType":"uint256","name":"_kilosAComprar","type":"uint256"}],"name":"comprarKilos","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"string","name":"_informeNFT","type":"string"},{"internalType":"string","name":"_datosLoteJSON","type":"string"},{"internalType":"uint256","name":"_kilosIniciales","type":"uint256"}],"name":"createLote","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"loteId","type":"uint256"},{"indexed":true,"internalType":"address","name":"propietario","type":"address"},{"indexed":false,"internalType":"uint256","name":"kilos","type":"uint256"}],"name":"LoteCreado","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"loteId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"precioPorKilo","type":"uint256"}],"name":"LotePuestoEnVenta","type":"event"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"inputs":[{"internalType":"uint256","name":"_loteId","type":"uint256"},{"internalType":"uint256","name":"_precioPorKilo","type":"uint256"}],"name":"ponerLoteEnVenta","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"ventaId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"loteId","type":"uint256"},{"indexed":true,"internalType":"address","name":"comprador","type":"address"},{"indexed":false,"internalType":"uint256","name":"kilosComprados","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"costeTotal","type":"uint256"}],"name":"VentaRegistrada","type":"event"},{"inputs":[{"internalType":"uint256","name":"_loteId","type":"uint256"}],"name":"getLoteDetails","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"kilosIniciales","type":"uint256"},{"internalType":"uint256","name":"kilosRestantes","type":"uint256"},{"internalType":"string","name":"informeNFT","type":"string"},{"internalType":"string","name":"datosLoteJSON","type":"string"},{"internalType":"address","name":"propietario","type":"address"},{"internalType":"bool","name":"existe","type":"bool"},{"internalType":"bool","name":"enVenta","type":"bool"},{"internalType":"uint256","name":"precioPorKilo","type":"uint256"}],"internalType":"struct TrazabilidadMielVenta.LoteMaestro","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalLotes","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"lotes","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"kilosIniciales","type":"uint256"},{"internalType":"uint256","name":"kilosRestantes","type":"uint256"},{"internalType":"string","name":"informeNFT","type":"string"},{"internalType":"string","name":"datosLoteJSON","type":"string"},{"internalType":"address","name":"propietario","type":"address"},{"internalType":"bool","name":"existe","type":"bool"},{"internalType":"bool","name":"enVenta","type":"bool"},{"internalType":"uint256","name":"precioPorKilo","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"ventas","outputs":[{"internalType":"uint256","name":"ventaId","type":"uint256"},{"internalType":"uint256","name":"loteId","type":"uint256"},{"internalType":"uint256","name":"kilosComprados","type":"uint256"},{"internalType":"uint256","name":"costeTotal","type":"uint256"},{"internalType":"address","name":"comprador","type":"address"},{"internalType":"string","name":"datosVentaJSON","type":"string"}],"stateMutability":"view","type":"function"}];

            // --- Referencias a DOM ---
            const getEl = id => document.getElementById(id);
            const connectMetamaskBtn = getEl('connect-metamask-btn');
            const walletInfoDiv = getEl('wallet-info');
            const walletConnectionDiv = getEl('wallet-connection');
            const dappContent = getEl('dapp-content');
            const notificationDiv = getEl('notification');
            const verifierSection = getEl('verifier-section');
            const findMyLotsBtn = getEl('find-my-lots-btn');
            const myLotsDropdown = getEl('my-lots-dropdown');
            const verifierResultDiv = getEl('verifier-result');
            const disconnectBtn = getEl('disconnect-btn');
            const walletAddressDisplay = getEl('wallet-address-display');
            
            const tabLote = getEl('tab-lote');
            const tabVenta = getEl('tab-venta');
            const contentLote = getEl('content-lote');
            const contentVenta = getEl('content-venta');

            const previewLoteBtn = getEl('preview-lote-btn');
            
            const previewVentaBtn = getEl('preview-venta-btn');
            const ventaLoteSelect = getEl('venta-lote-select');
            const ventaPrecioEurInput = getEl('venta-precio-eur');
            const ventaPrecioMaticInput = getEl('venta-precio-matic');
            const maticRateInfo = getEl('matic-rate-info');
            const ventaImgProductoInput = getEl('venta-img-producto');
            
            const adminPanel = getEl('admin-panel');
            const contractStatusSpan = getEl('contract-status');
            const pauseBtn = getEl('pause-btn');
            const unpauseBtn = getEl('unpause-btn');

            // Modals
            const previewLoteModal = getEl('preview-lote-modal');
            const previewLoteContent = getEl('preview-lote-content');
            const downloadLotePngBtn = getEl('download-lote-png-btn');
            const downloadLotePdfBtn = getEl('download-lote-pdf-btn');
            const confirmRegisterLoteBtn = getEl('confirm-register-lote-btn');
            const cancelLotePreviewBtn = getEl('cancel-lote-preview-btn');
            
            const previewVentaModal = getEl('preview-venta-modal');
            const previewVentaContent = getEl('preview-venta-content');
            const downloadVentaPngBtn = getEl('download-venta-png-btn');
            const downloadVentaPdfBtn = getEl('download-venta-pdf-btn');
            const confirmRegisterVentaBtn = getEl('confirm-register-venta-btn');
            const cancelVentaPreviewBtn = getEl('cancel-venta-preview-btn');

            const receiptModal = getEl('receipt-modal');
            const receiptContent = getEl('receipt-content');
            const downloadReceiptPngBtn = getEl('download-receipt-png-btn');
            const downloadReceiptPdfBtn = getEl('download-receipt-pdf-btn');
            const closeReceiptBtn = getEl('close-receipt-btn');


            let provider, signer, userAddress, contract;
            let isContractPaused = false;
            let currentLoteData = {};
            let currentVentaData = {};
            let maticToEurRate = 0;

            // --- Lógica de la Aplicación ---

            function switchTab(activeTabId) {
                const tabs = { lote: tabLote, venta: tabVenta };
                const contents = { lote: contentLote, venta: contentVenta };
                for (const id in tabs) {
                    const isActive = id === activeTabId;
                    tabs[id].classList.toggle('active', isActive);
                    contents[id].classList.toggle('active', isActive);
                }
            }
            tabLote.addEventListener('click', () => switchTab('lote'));
            tabVenta.addEventListener('click', () => switchTab('venta'));

            function showNotification(message, type, txHash = null) {
                let bgColor, textColor, borderColor;
                switch (type) {
                    case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-800'; borderColor = 'border-green-500'; break;
                    case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-800'; borderColor = 'border-red-500'; break;
                    default: bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; borderColor = 'border-blue-500'; break;
                }
                let content = `<p>${message}</p>`;
                if (txHash) {
                    const explorerUrl = `https://polygonscan.com/tx/${txHash}`; // Apunta a PolygonScan Mainnet
                    content += `<a href="${explorerUrl}" target="_blank" rel="noopener noreferrer" class="font-semibold underline mt-2 inline-block">Ver en PolygonScan</a>`;
                }
                notificationDiv.innerHTML = `<div class="p-4 rounded-lg border-l-4 ${bgColor} ${textColor} ${borderColor}">${content}</div>`;
            }
            
            function disconnectWallet() {
                provider = null;
                signer = null;
                userAddress = null;
                contract = null;

                walletConnectionDiv.style.display = 'block';
                dappContent.classList.add('hidden');
                verifierSection.classList.add('hidden');
                adminPanel.classList.add('hidden');
                walletInfoDiv.classList.add('hidden');
                walletAddressDisplay.innerHTML = '';
                showNotification('Cartera desconectada.', 'info');
            }

            async function connectWallet() {
                if (typeof window.ethereum === 'undefined') {
                    showNotification('MetaMask no está instalado. Por favor, instala la extensión.', 'error');
                    return;
                }
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    const currentChainId = await provider.send('eth_chainId', []);
                    if (currentChainId !== POLYGON_CHAIN_ID) {
                        try {
                            await provider.send('wallet_switchEthereumChain', [{ chainId: POLYGON_CHAIN_ID }]);
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                showNotification('La red Polygon Mainnet no está en tu MetaMask. Por favor, aprueba para añadirla.', 'info');
                                try {
                                    await provider.send('wallet_addEthereumChain', [
                                        {
                                            chainId: POLYGON_CHAIN_ID,
                                            chainName: 'Polygon Mainnet',
                                            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                            rpcUrls: ['https://polygon-rpc.com/'],
                                            blockExplorerUrls: ['https://polygonscan.com/'],
                                        },
                                    ]);
                                } catch (addError) {
                                    showNotification('No se pudo añadir la red Polygon Mainnet a MetaMask.', 'error');
                                    return;
                                }
                            } else {
                                showNotification('Error al cambiar de red en MetaMask.', 'error');
                                return;
                            }
                        }
                    }

                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                    walletAddressDisplay.innerHTML = `Conectado: <strong class="text-gray-900">${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}</strong>`;
                    walletInfoDiv.classList.remove('hidden');
                    walletConnectionDiv.style.display = 'none';
                    dappContent.classList.remove('hidden');
                    verifierSection.classList.remove('hidden');
                    showNotification('¡Cartera conectada con éxito a Polygon!', 'success');

                    await checkAdminStatus();
                    await fetchMaticPrice();
                    await populateMyLotsForSale();
                } catch (err) {
                    console.error('Error al conectar la cartera:', err);
                    showNotification('Error al conectar la cartera. ' + (err.message || ''), 'error');
                }
            }

            async function checkAdminStatus() {
                if (!contract) return;
                try {
                    const contractOwner = await contract.owner();
                    isContractPaused = await contract.paused();
                    
                    console.log("Contract Owner:", contractOwner);
                    console.log("Connected User:", userAddress);

                    if (contractOwner.toLowerCase() === userAddress.toLowerCase()) {
                        adminPanel.classList.remove('hidden');
                        updatePauseStatusUI();
                    }
                } catch (err) {
                    console.error("Error al comprobar el estado de administrador:", err);
                }
            }
            
            function updatePauseStatusUI() {
                if (isContractPaused) {
                    contractStatusSpan.textContent = "En Pausa";
                    contractStatusSpan.className = "font-bold text-lg text-red-600";
                } else {
                    contractStatusSpan.textContent = "Activo";
                    contractStatusSpan.className = "font-bold text-lg text-green-600";
                }
            }
            
            function setLoadingState(button, isLoading) {
                button.disabled = isLoading;
                const textSpan = button.querySelector('.btn-text');
                const spinnerDiv = button.querySelector('.spinner');
                if (isLoading) {
                    if(textSpan) textSpan.classList.add('hidden');
                    if(spinnerDiv) spinnerDiv.classList.remove('hidden');
                } else {
                    if(textSpan) textSpan.classList.remove('hidden');
                    if(spinnerDiv) spinnerDiv.classList.add('hidden');
                }
            }

            async function callContractMethod(button, methodName, args = [], value = 0) {
                 if (isContractPaused && ['createLote', 'ponerLoteEnVenta'].includes(methodName)) {
                    showNotification("Operación no disponible. El contrato está actualmente en pausa por el administrador.", "error");
                    return;
                }
                if (!signer || !contract) { showNotification('Por favor, conecta tu cartera primero.', 'error'); return; }
                
                setLoadingState(button, true);

                try {
                    const contractWithSigner = contract.connect(signer);
                    const tx = await contractWithSigner[methodName](...args, { value: value });
                    showNotification('Transacción enviada. Esperando confirmación...', 'info', tx.hash);
                    
                    const receipt = await tx.wait();
                    
                    if (methodName === 'ponerLoteEnVenta') {
                        showTransactionReceiptModal(receipt.transactionHash, currentVentaData);
                    } else {
                        showNotification('¡Transacción confirmada con éxito!', 'success', receipt.transactionHash);
                    }


                    if (methodName === 'pause' || methodName === 'unpause' || methodName === 'ponerLoteEnVenta') {
                        await checkAdminStatus();
                        await populateMyLotsForSale();
                    }
                    return receipt;
                } catch (err) {
                    console.error('Error en la transacción:', err);
                    const reason = err.reason || (err.data ? err.data.message : null) || err.message || 'La transacción ha fallado.';
                    showNotification(reason, 'error');
                } finally {
                    setLoadingState(button, false);
                }
            }
            
            async function uploadToPinata(file) {
                if (!PINATA_API_KEY || !PINATA_SECRET_API_KEY) throw new Error("Las claves API de Pinata no están configuradas. Esto debería manejarse en un backend.");
                showNotification('Subiendo archivo a IPFS...', 'info');
                const url = `https://api.pinata.cloud/pinning/pinFileToIPFS`;
                let data = new FormData();
                data.append('file', file);
                const response = await fetch(url, { method: 'POST', headers: { 'pinata_api_key': PINATA_API_KEY, 'pinata_secret_api_key': PINATA_SECRET_API_KEY }, body: data });
                if (!response.ok) throw new Error('Error al subir el archivo a Pinata.');
                const result = await response.json();
                return result.IpfsHash;
            }

            // --- Lógica de Pestañas ---

            // Registrar Lote
            function generateLoteId() {
                const date = new Date();
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const random = Math.floor(1000 + Math.random() * 9000);
                return `${year}${month}${day}-${random}`;
            }

            function handleImageUpload(event) {
                const input = event.target;
                const key = input.id.split('-').pop();
                const file = input.files[0];
                const previewElement = getEl(`preview-${key}`);
                
                if (file) {
                    currentLoteData.images[key] = file;
                    previewElement.src = URL.createObjectURL(file);
                    previewElement.classList.remove('hidden');
                }
            }

            function showLotePreviewModal() {
                const loteId = generateLoteId();
                currentLoteData.id = loteId;
                
                const data = {
                    id: loteId,
                    apicultor: { nombre: getEl('apicultor-nombre').value, rega: getEl('apicultor-rega').value },
                    lote: {
                        kilos: getEl('lote-kilos').value, ubicacion: getEl('lote-ubicacion').value,
                        fechaCosecha: getEl('lote-fecha-cosecha').value, fechaExtraccion: getEl('lote-fecha-extraccion').value,
                        fechaMaduracion: getEl('lote-fecha-maduracion').value, fechaEnvasado: getEl('lote-fecha-envasado').value,
                    },
                    miel: { variedad: getEl('miel-variedad').value, tipoExtraccion: getEl('miel-extraccion-tipo').value, detalles: getEl('miel-detalles').value },
                    timestamp: new Date().toISOString()
                };
                currentLoteData.details = data;

                let previewHTML = `<div class="p-4"><h3 class="text-2xl font-bold text-center mb-4">Informe del Lote (ID: ${data.id})</h3><p class="text-center text-sm text-gray-500 mb-6">Generado el: ${new Date(data.timestamp).toLocaleString('es-ES')}</p><div class="space-y-4"><div><h4 class="font-bold text-lg border-b pb-1 mb-2">Datos del Apicultor</h4><p><strong>Nombre:</strong> ${data.apicultor.nombre}</p><p><strong>REGA:</strong> ${data.apicultor.rega}</p></div><div><h4 class="font-bold text-lg border-b pb-1 mb-2">Datos del Lote</h4><p><strong>Kilos:</strong> ${data.lote.kilos} kg</p><p><strong>Ubicación:</strong> ${data.lote.ubicacion}</p></div><div><h4 class="font-bold text-lg border-b pb-1 mb-2">Proceso</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">`;
                const stages = {cosecha: 'Cosecha', extraccion: 'Extracción', maduracion: 'Maduración', envasado: 'Envasado'};
                for(const [key, name] of Object.entries(stages)) {
                    const dateValue = data.lote[`fecha${name.charAt(0).toUpperCase() + name.slice(1).replace('ó', 'o')}`];
                    const imgSrc = currentLoteData.images[key] ? URL.createObjectURL(currentLoteData.images[key]) : 'https://placehold.co/150x100/eee/ccc?text=Sin+Foto';
                    previewHTML += `<div class="text-center"><p class="font-semibold">${name}</p><p class="text-sm">${dateValue || 'N/A'}</p><img src="${imgSrc}" class="w-full h-auto mt-1 rounded shadow"></div>`;
                }
                previewHTML += `</div></div><div><h4 class="font-bold text-lg border-b pb-1 mb-2">Características de la Miel</h4><p><strong>Variedad:</strong> ${data.miel.variedad}</p><p><strong>Tipo de Extracción:</strong> ${data.miel.tipoExtraccion}</p><p><strong>Detalles:</strong> ${data.miel.detalles || 'N/A'}</p></div></div></div>`;

                previewLoteContent.innerHTML = previewHTML;
                previewLoteModal.classList.remove('hidden');
            }

            async function downloadReport(format, contentElement, id) {
                const canvas = await html2canvas(contentElement, { scale: 2 });
                if (format === 'png') {
                    const link = document.createElement('a');
                    link.download = `informe-${id}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } else if (format === 'pdf') {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`informe-${id}.pdf`);
                }
            }

            async function confirmAndRegisterLote() {
                const button = confirmRegisterLoteBtn;
                try {
                    setLoadingState(button, true);
                    const canvas = await html2canvas(previewLoteContent, { scale: 2 });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    const reportFile = new File([blob], `informe-lote-${currentLoteData.id}.png`, { type: 'image/png' });
                    
                    const imageHash = await uploadToPinata(reportFile);
                    showNotification(`Informe de previsualización subido a IPFS. Hash: ${imageHash}`, 'info');

                    const dataToStore = currentLoteData.details;
                    
                    await callContractMethod(button, 'createLote', [`ipfs://${imageHash}`, JSON.stringify(dataToStore), dataToStore.lote.kilos]);
                    previewLoteModal.classList.add('hidden');
                } catch(err) {
                    showNotification(err.message, 'error');
                } finally {
                    setLoadingState(button, false);
                }
            }

            // Poner en Venta
            async function fetchMaticPrice() {
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=matic-network&vs_currencies=eur');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    maticToEurRate = data['matic-network'].eur;
                    maticRateInfo.textContent = `1 MATIC ≈ ${maticToEurRate.toFixed(2)} €`;
                } catch (error) {
                    console.error("Could not fetch MATIC price:", error);
                    maticRateInfo.textContent = "No se pudo obtener el tipo de cambio.";
                }
            }

            function updateMaticPrice() {
                if (maticToEurRate > 0) {
                    const eurPrice = parseFloat(ventaPrecioEurInput.value);
                    if (!isNaN(eurPrice)) {
                        const maticPrice = eurPrice / maticToEurRate;
                        ventaPrecioMaticInput.value = maticPrice.toFixed(8);
                    } else {
                        ventaPrecioMaticInput.value = "";
                    }
                }
            }

            async function populateMyLotsForSale() {
                if (!contract || !userAddress) return;
                const filter = contract.filters.LoteCreado(null, userAddress);
                const events = await contract.queryFilter(filter);
                ventaLoteSelect.innerHTML = '<option value="">Selecciona un lote</option>';
                let hasLotesNotForSale = false;
                for (const event of events) {
                    const loteId = event.args.loteId;
                    const loteDetails = await getLoteDetails(loteId.toString());
                    if (loteDetails && !loteDetails.enVenta) {
                        const option = document.createElement('option');
                        option.value = loteId.toString();
                        option.textContent = `Lote ID: ${loteId.toString()} (${loteDetails.kilosRestantes} kg restantes)`;
                        ventaLoteSelect.appendChild(option);
                        hasLotesNotForSale = true;
                    }
                }
                if (!hasLotesNotForSale) {
                    ventaLoteSelect.innerHTML = '<option value="">No tienes lotes para poner en venta</option>';
                }
            }
            
            async function showVentaPreviewModal() {
                const loteId = ventaLoteSelect.value;
                const precio = ventaPrecioEurInput.value;
                const imagenFile = ventaImgProductoInput.files[0];

                if (!loteId || !precio) {
                    showNotification("Por favor, selecciona un lote y define un precio.", "error");
                    return;
                }
                
                const loteDetails = await getLoteDetails(loteId);
                currentVentaData = { loteId, precio, imagenFile, loteDetails };

                const imgSrc = imagenFile ? URL.createObjectURL(imagenFile) : 'https://placehold.co/300x200/eee/ccc?text=Sin+Foto+Producto';
                
                let previewHTML = `<div class="p-4"><h3 class="text-xl font-bold text-center mb-4">Poner en Venta Lote ${loteId}</h3>
                    <img src="${imgSrc}" class="w-full h-auto max-h-64 object-contain mx-auto rounded shadow mb-4">
                    <div class="space-y-2">
                        <p><strong>Precio:</strong> ${precio} € por kilo (${ventaPrecioMaticInput.value} MATIC)</p>
                        <p><strong>Kilos disponibles:</strong> ${loteDetails.kilosRestantes} kg</p>
                        <p><strong>Variedad:</strong> ${JSON.parse(loteDetails.datosLoteJSON).miel.variedad}</p>
                    </div></div>`;

                previewVentaContent.innerHTML = previewHTML;
                previewVentaModal.classList.remove('hidden');
            }

            async function confirmAndRegisterVenta() {
                const { loteId, precio } = currentVentaData;
                const button = confirmRegisterVentaBtn;
                try {
                    setLoadingState(button, true);
                    const maticPrice = parseFloat(ventaPrecioMaticInput.value);
                    if (isNaN(maticPrice) || maticPrice <= 0) {
                        throw new Error("El precio en MATIC no es válido. Revisa el precio en Euros y el tipo de cambio.");
                    }
                    const precioEnWei = ethers.utils.parseUnits(maticPrice.toString(), 'ether');
                    await callContractMethod(button, 'ponerLoteEnVenta', [loteId, precioEnWei]);
                    previewVentaModal.classList.add('hidden');
                } catch(err) {
                    showNotification(err.message, 'error');
                } finally {
                    setLoadingState(button, false);
                }
            }
            
            function showTransactionReceiptModal(txHash, saleData) {
                const { loteId, loteDetails, imagenFile } = saleData;
                const txUrl = `https://polygonscan.com/tx/${txHash}`;
                const imgSrc = imagenFile ? URL.createObjectURL(imagenFile) : 'https://placehold.co/300x200/eee/ccc?text=Sin+Foto+Producto';

                let receiptHTML = `<div class="p-4"><h3 class="text-xl font-bold text-center mb-4">Lote ${loteId} puesto en venta</h3>
                    <img src="${imgSrc}" class="w-full h-auto max-h-48 object-contain mx-auto rounded shadow mb-4">
                    <div class="space-y-2 text-sm">
                        <p><strong>Precio:</strong> ${ventaPrecioEurInput.value} €/kg (${ventaPrecioMaticInput.value} MATIC/kg)</p>
                        <p><strong>Enlace de la Transacción:</strong> <a href="${txUrl}" target="_blank" class="text-blue-600 hover:underline break-all">${txUrl}</a></p>
                    </div>
                    <div id="receipt-qrcode" class="mt-4 flex justify-center"></div>
                </div>`;
                
                receiptContent.innerHTML = receiptHTML;
                
                new QRCode(getEl("receipt-qrcode"), {
                    text: txUrl,
                    width: 128,
                    height: 128,
                });

                receiptModal.classList.remove('hidden');
            }


            async function getLoteDetails(id) {
                 if (!contract || !id) return null;
                 try {
                    const lote = await contract.getLoteDetails(id);
                    if (!lote.existe) return null;
                    return {
                        id: lote.id.toString(), kilosIniciales: lote.kilosIniciales.toString(), kilosRestantes: lote.kilosRestantes.toString(),
                        informeNFT: lote.informeNFT, datosLoteJSON: lote.datosLoteJSON, propietario: lote.propietario,
                        existe: lote.existe, enVenta: lote.enVenta, precioPorKilo: lote.precioPorKilo.toString(),
                    };
                 } catch (e) { return null; }
            }
            
            // Verificador
            async function findMyLots() {
                if (!contract || !userAddress) { showNotification('Conecta tu cartera primero.', 'error'); return; }
                verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-blue-100 text-blue-800">Buscando lotes creados por tu cartera...</div>`;
                try {
                    const filter = contract.filters.LoteCreado(null, userAddress);
                    const events = await contract.queryFilter(filter);

                    if (events.length === 0) {
                        verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-yellow-100 text-yellow-800">No se encontraron lotes creados por tu cartera.</div>`;
                        myLotsDropdown.classList.add('hidden');
                        return;
                    }

                    myLotsDropdown.innerHTML = '<option value="">-- Selecciona un Lote --</option>';
                    const foundIds = new Set();
                    events.forEach(event => {
                        const loteId = event.args.loteId.toString();
                        if (!foundIds.has(loteId)) {
                            const option = document.createElement('option');
                            option.value = loteId;
                            option.textContent = `Lote ID: ${loteId}`;
                            myLotsDropdown.appendChild(option);
                            foundIds.add(loteId);
                        }
                    });
                    myLotsDropdown.classList.remove('hidden');
                    verifierResultDiv.innerHTML = '';
                } catch (err) {
                    console.error("Error al buscar lotes:", err);
                    verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-800">${err.message}</div>`;
                }
            }
            
            async function verifyData(id) {
                if (!id) { verifierResultDiv.innerHTML = ''; return; }
                verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-blue-100 text-blue-800">Buscando datos del lote ${id}...</div>`;
                const lote = await getLoteDetails(id);
                if (lote) {
                    verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-green-100 text-green-800"><h4 class="font-bold">¡Datos Encontrados!</h4><pre class="mt-2 font-mono bg-white p-2 rounded text-xs whitespace-pre-wrap break-all">${JSON.stringify(lote, null, 2)}</pre></div>`;
                } else {
                    verifierResultDiv.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-800">No se pudieron encontrar los datos del lote ${id}.</div>`;
                }
            }

            // --- Asignación de Eventos ---
            connectMetamaskBtn.addEventListener('click', connectWallet);
            disconnectBtn.addEventListener('click', disconnectWallet);
            
            // Lote
            previewLoteBtn.addEventListener('click', showLotePreviewModal);
            ['cosecha', 'extraccion', 'maduracion', 'envasado'].forEach(key => {
                getEl(`lote-img-${key}`).addEventListener('change', handleImageUpload);
            });
            currentLoteData.images = {};

            // Venta
            previewVentaBtn.addEventListener('click', showVentaPreviewModal);
            ventaPrecioEurInput.addEventListener('input', updateMaticPrice);
            
            // Verificador
            findMyLotsBtn.addEventListener('click', findMyLots);
            myLotsDropdown.addEventListener('change', (e) => verifyData(e.target.value));
            
            // Admin
            pauseBtn.addEventListener('click', (e) => callContractMethod(e.currentTarget, 'pause'));
            unpauseBtn.addEventListener('click', (e) => callContractMethod(e.currentTarget, 'unpause'));

            // Modals
            downloadLotePngBtn.addEventListener('click', () => downloadReport('png', previewLoteContent, currentLoteData.id));
            downloadLotePdfBtn.addEventListener('click', () => downloadReport('pdf', previewLoteContent, currentLoteData.id));
            cancelLotePreviewBtn.addEventListener('click', () => previewLoteModal.classList.add('hidden'));
            confirmRegisterLoteBtn.addEventListener('click', confirmAndRegisterLote);

            downloadVentaPngBtn.addEventListener('click', () => downloadReport('png', previewVentaContent, currentVentaData.loteId));
            downloadVentaPdfBtn.addEventListener('click', () => downloadReport('pdf', previewVentaContent, currentVentaData.loteId));
            cancelVentaPreviewBtn.addEventListener('click', () => previewVentaModal.classList.add('hidden'));
            confirmRegisterVentaBtn.addEventListener('click', confirmAndRegisterVenta);

            downloadReceiptPngBtn.addEventListener('click', () => downloadReport('png', receiptContent, `recibo-${currentVentaData.loteId}`));
            downloadReceiptPdfBtn.addEventListener('click', () => downloadReport('pdf', receiptContent, `recibo-${currentVentaData.loteId}`));
            closeReceiptBtn.addEventListener('click', () => receiptModal.classList.add('hidden'));
        });
    </script>
</body>
</html>
